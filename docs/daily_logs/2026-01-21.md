# 개발 일지 - 2026-01-21

## ✅ 완료된 기능

### 1. AI 채팅 UI 전면 개편 (감정 캐릭터 시스템)

**작업 내용:**
- 감정-캐릭터 매핑 시스템 구현 (`EmotionCharacterMap`)
- AI 메시지 버블에 캐릭터 이미지 표시 (48px 원형)
- 캐릭터 기반 감정 선택 UI (4열 그리드 레이아웃)
- 감정별 배경색 자동 변경 (파스텔 톤)
- 말풍선 디자인 모던화 (카카오톡 스타일)
- 타이핑 인디케이터 캐릭터 통합
- 헤더에 캐릭터 미니 아이콘 추가

**수정/추가 파일:**
```
✨ 신규: lib/shared/constants/emotion_character_map.dart
🔧 수정: lib/features/diary/views/diary_chat_write_page/
  - diary_chat_write_page.dart
  - widgets/chat_message_bubble.dart
  - widgets/chat_emotion_selector.dart
  - widgets/typing_indicator.dart
📝 문서: docs/EMOTI_FLOW_DEVELOPMENT_PLAN.md
📝 문서: docs/EMOTI_FLOW_UI_UX_PLAN.md
```

**커밋 메시지 (복사용):**
```
feat: AI 채팅 UI 전면 개편 - 감정 캐릭터 시스템 통합

- EmotionCharacterMap 클래스 추가 (10가지 감정 매핑)
- AI 메시지 버블에 캐릭터 이미지 표시
- 캐릭터 기반 감정 선택 UI (4열 그리드)
- 감정별 배경색 자동 변경
- 말풍선 디자인 모던화
- 타이핑 인디케이터 캐릭터 통합
```

**테스트 사항:**
- [ ] 10가지 감정 각각 선택 테스트
- [ ] 캐릭터 이미지 로딩 확인
- [ ] 배경색 변경 확인
- [ ] 이미지 로드 실패 시 fallback 확인

---

---

### 2. AI 채팅 UI/UX 개선 (사용자 피드백 반영)

**작업 내용:**
- 앱바 타이틀 간소화 (캐릭터 아이콘만 표시)
- 키보드 외부 터치 시 자동 닫기 (전역 적용)
  - `KeyboardDismissibleScaffold` 공통 위젯 생성
- 감정 선택 UI 오버플로우 수정
  - maxHeight 제한 + SingleChildScrollView
  - 연한 크림색 배경 (#FFFDF7)
- 감정 선택 페이지 추가 (AI 대화 진입 전)
  - "선택 안함" 옵션 추가 (대표 캐릭터)
  - 선택 후 채팅방으로 자동 전환
- 감정 선택 UI 지연 개선
  - Fallback 메시지 즉시 표시
  - Gemini API 비동기 호출로 변경
  - 성능 로그 추가 (원인 분석용)
- 앱 로고 잘림 문제 수정 (pubspec.yaml)

**수정/추가 파일:**
```
✨ 신규: lib/shared/widgets/keyboard_dismissible_scaffold.dart
✨ 신규: lib/features/diary/views/emotion_selection_page/emotion_selection_page.dart
🔧 수정: lib/features/diary/views/diary_chat_write_page/
  - diary_chat_write_page.dart
  - widgets/chat_emotion_selector.dart
🔧 수정: pubspec.yaml
```

**커밋 메시지 (복사용):**
```
fix: AI 채팅 UI/UX 개선 - 사용자 피드백 반영

- 앱바 타이틀 간소화 (캐릭터만 표시)
- 키보드 외부 터치 시 자동 닫기 (전역 적용)
- 감정 선택 UI 오버플로우 수정
- 감정 선택 페이지 추가 (진입점 개선)
- 감정 선택 UI 지연 개선 (Fallback 즉시 표시)
- 앱 로고 잘림 문제 수정
```

**성능 개선 결과:**
- Before: 감정 선택 UI 표시까지 2-3초 (Gemini API 대기)
- After: 즉시 표시 (<100ms) + API 응답 비동기 처리

**테스트 사항:**
- [x] 키보드 외부 터치로 닫기 확인
- [x] 감정 선택 UI 오버플로우 없음
- [x] 감정 선택 페이지 → 채팅방 전환
- [x] "선택 안함" 옵션 동작 확인
- [ ] 앱 로고 확인 (재빌드 후)

---

### 3. 사용자 피드백 추가 반영 + 테스트 코드 작성

**작업 내용:**
- 채팅 메시지 폰트 사이즈 축소 (15px → 14px)
- 라우터 진입점 변경 (`/diaries/chat` → EmotionSelectionPage 먼저 표시)
- DiaryChatWritePage에서 ChatEmotionSelector 위젯 제거 (미사용 코드)
- `_selectEmotion` 메서드 제거 (감정 선택 페이지로 이동)
- `_emotionSelected` 플래그 제거 (불필요)
- 테스트 코드 작성:
  - `test/shared/constants/emotion_character_map_test.dart` (단위 테스트)
  - `test/performance/emotion_selection_performance_test.dart` (성능 테스트)
- 트러블슈팅 문서에 성능 개선 내용 추가

**수정/추가 파일:**
```
✨ 신규: test/shared/constants/emotion_character_map_test.dart
✨ 신규: test/performance/emotion_selection_performance_test.dart
🔧 수정: lib/features/diary/views/diary_chat_write_page/
  - diary_chat_write_page.dart (ChatEmotionSelector 제거)
  - widgets/chat_message_bubble.dart (폰트 14px)
🔧 수정: lib/routes/app_router.dart (진입점 변경)
📝 수정: docs/troubleshooting.md (성능 개선 문서화)
```

**커밋 메시지 (복사용):**
```
refactor: 감정 선택 페이지 분리 + 테스트 코드 추가

- 채팅 메시지 폰트 사이즈 14px로 축소
- /diaries/chat → EmotionSelectionPage 진입점 변경
- DiaryChatWritePage에서 ChatEmotionSelector 제거
- 미사용 코드 정리 (_selectEmotion, _emotionSelected)
- EmotionCharacterMap 단위 테스트 작성
- 성능 테스트 코드 작성 (지연 원인 분석)
- 트러블슈팅 문서 업데이트 (성능 개선 내용)
```

**테스트 실행:**
```bash
# 단위 테스트
flutter test test/shared/constants/emotion_character_map_test.dart

# 성능 테스트
flutter test test/performance/emotion_selection_performance_test.dart
```

---

### 4. Navigator 에러 수정 + 감정 선택 UI 개선

**작업 내용:**
- Navigator 에러 수정 (`pushReplacement` → `push`)
  - GoRouter와 충돌하는 page-based navigation 에러 해결
- 대표 캐릭터 변경 (`Emoti3.png` → `Emoti.png`)
  - 배경이 있는 캐릭터로 변경
- 감정 선택 페이지 적응형 UI 적용
  - `LayoutBuilder` + `MediaQuery`로 화면 크기 대응
  - 모든 요소에 적응형 크기 적용 (캐릭터 이미지, 그리드 아이템, 텍스트)
- 그리드 레이아웃 변경 (4x3 → 3x4)
  - `crossAxisCount: 4` → `3`으로 변경
  - 3열 4행으로 더 여유있는 레이아웃
- 오버플로우 해결
  - `Flexible` 위젯으로 텍스트 영역 처리
  - `constraints` 추가로 최소/최대 크기 보장

**수정 파일:**
```
🔧 수정: lib/features/diary/views/emotion_selection_page/emotion_selection_page.dart
🔧 수정: lib/shared/constants/emotion_character_map.dart
```

**커밋 메시지 (복사용):**
```
fix: 감정 선택 페이지 Navigator 에러 및 UI 개선

- Navigator 에러 수정 (pushReplacement → push)
- 대표 캐릭터 Emoti.png로 변경
- 적응형 UI 전면 적용 (LayoutBuilder + MediaQuery)
- 그리드 레이아웃 3x4로 변경 (4x3 → 3x4)
- 오버플로우 해결 (Flexible + constraints)
- 모든 요소 화면 크기에 맞게 반응형 처리

Fixes: page-based route Navigator assertion error
```

---

### 5. 감정 선택 UI 개선 + AI 입력 검증 로직 추가

**작업 내용:**
- 감정 캐릭터 잘림 방지
  - `BoxShape.circle` → `BorderRadius.circular(16)` (둥근 사각형)
  - `Padding` 추가하여 캐릭터 이미지 여백 확보
  - `BoxFit.cover` → `BoxFit.contain`으로 변경
  - 배경은 잘려도 캐릭터는 온전하게 표시
- 선택 모션 개선
  - 보라색 배경 원 제거
  - 대신 border 강조 (1.5px → 3px)
  - 그림자 효과 강화 (blurRadius: 16, spreadRadius: 3)
  - `AnimatedContainer`로 부드러운 전환 효과
  - `AnimatedDefaultTextStyle`로 텍스트 색상 애니메이션
  - 글자 색상 변경은 유지 (보라색 → 주 색상)
- AI 입력 검증 로직 추가
  - 의미 없는 답변 감지 (`_isInvalidUserResponse`)
    - 너무 짧은 답변 (1-2글자)
    - 의미 없는 문자 반복 (ㅋㅋㅋㅋ, ....)
    - 랜덤 키 입력 (asdf, qwer 등)
    - 대부분 특수문자
    - 숫자만 입력
  - 이해 불가 시 다시 물어보기 (`_getInvalidResponseMessage`)
    - 4가지 다양한 응답 메시지
    - 무조건 공감하는 대신 구체적으로 다시 질문

**수정 파일:**
```
🔧 수정: lib/features/diary/views/emotion_selection_page/emotion_selection_page.dart
🔧 수정: lib/core/ai/gemini/gemini_service.dart
```

**커밋 메시지 (복사용):**
```
feat: 감정 선택 UI 개선 및 AI 입력 검증 추가

UI 개선:
- 감정 캐릭터 잘림 방지 (둥근 사각형 + 패딩)
- 선택 모션 개선 (border 강조 + 그림자 효과)
- AnimatedContainer로 부드러운 전환
- BoxFit.contain으로 캐릭터 온전히 표시

AI 개선:
- 의미 없는 답변 감지 로직 추가
- 이해 불가 시 다시 질문하는 응답
- 무조건 공감 대신 스마트한 대화

Fixes: 캐릭터 이미지 잘림, 과도한 AI 공감
```

---

### 6. 감정 선택 UI 최종 개선 (빈 공간 제거)

**작업 내용:**
- 미사용 파일 정리 확인
  - `emoti.png`, `Emoti 1.png` 이미 삭제됨
  - 현재 사용: `Emoti2.png` (대표), `Emoti3.png`, `Emoti_name.png`
- 감정 선택 UI 빈 공간 제거
  - 패딩: `10px → 4px` (대표 캐릭터)
  - 패딩: `6px → 2px` (감정 아이템)
  - 이미지가 박스를 거의 채우도록 개선
- 선택 효과 강화
  - 미선택 시: border 투명 (완전히 제거)
  - 선택 시: border 3.5px + 강한 그림자
  - BorderRadius 20px로 더 부드럽게
  - 그림자 효과 강화 (blurRadius: 20, spreadRadius: 4)

**수정 파일:**
```
🔧 수정: lib/features/diary/views/emotion_selection_page/emotion_selection_page.dart
```

**커밋 메시지 (복사용):**
```
refactor: 감정 선택 UI 빈 공간 제거 및 선택 효과 개선

- 패딩 최소화 (10px→4px, 6px→2px)
- 이미지가 박스를 거의 채우도록 개선
- 미선택 시 border 완전 제거 (투명)
- 선택 시 border 3.5px + 강한 그림자
- BorderRadius 20px로 더 부드럽게
- 대표 캐릭터 Emoti2.png 적용

Fixes: 감정 선택 UI 빈 공간 어색함
```

**개선 효과:**
```
Before:
❌ 네모박스와 이미지 사이 빈 공간 어색
❌ padding 10px로 이미지 작게 표시
❌ 미선택 시에도 border 표시

After:
✅ 빈 공간 최소화 (padding 2-4px)
✅ 이미지가 박스를 거의 채움
✅ 미선택 시 border 없음 (깔끔)
✅ 선택 시 강한 테두리 + 그림자
```

**개선 효과:**
```
Before:
❌ 감정 캐릭터 머리 부분 잘림
❌ 선택 시 보라색 원 배경 (투박함)
❌ "asf" 같은 답변에도 공감

After:
✅ 캐릭터 온전히 표시 (둥근 사각형 + 패딩)
✅ 세련된 선택 효과 (border + 그림자)
✅ 이상한 답변은 다시 물어봄
```

---

## 📝 다음 작업 예정

1. 캐릭터별 AI 말투 차별화 (프롬프트 시스템 문서화)
2. 라우팅 버그 수정 (AI 채팅→상세 페이지)
3. 다크모드 색상 대비 개선
4. 감정 통계 대시보드 구현

